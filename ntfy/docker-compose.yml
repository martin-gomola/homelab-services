version: "3.8"

services:
  ntfy:
    image: binwiederhier/ntfy:latest
    container_name: ntfy
    command: serve
    env_file:
      - .env
    environment:
      TZ: ${TZ:-UTC}
      NTFY_BASE_URL: ${NTFY_BASE_URL}
      NTFY_UPSTREAM_BASE_URL: ${NTFY_UPSTREAM_BASE_URL:-https://ntfy.sh}
      NTFY_CACHE_FILE: /var/lib/ntfy/cache.db
      NTFY_AUTH_FILE: /var/lib/ntfy/auth.db
      NTFY_AUTH_DEFAULT_ACCESS: ${NTFY_AUTH_DEFAULT_ACCESS:-deny-all}
      NTFY_BEHIND_PROXY: ${NTFY_BEHIND_PROXY:-true}
      NTFY_ATTACHMENT_CACHE_DIR: /var/lib/ntfy/attachments
      NTFY_ENABLE_LOGIN: ${NTFY_ENABLE_LOGIN:-true}
      NTFY_ENABLE_SIGNUP: ${NTFY_ENABLE_SIGNUP:-false}
    user: "${PUID:-1000}:${PGID:-1000}"
    volumes:
      - ${DOCKER_ROOT}/ntfy/cache:/var/cache/ntfy
      - ${DOCKER_ROOT}/ntfy/config:/etc/ntfy
      - ${DOCKER_ROOT}/ntfy/db:/var/lib/ntfy
    ports:
      - "${NTFY_PORT}:80"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    stop_grace_period: 10s
